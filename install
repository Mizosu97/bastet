#!/bin/bash


echo "Updating your current install to the latest packages."
sudo -S pacman -Syu

echo "Installing a few dependencies."
sudo -S pacman -S lua feh i3-gaps i3status dmenu xclip maim alacritty firefox neovim neofetch fish

if [ -d "$HOME/.mizOS" ]; then
	mv $HOME/.mizOS $HOME/mizOS
	mv $HOME/mizOS /var/
	sudo chmod 777 /var/mizOS
fi

if [ -d "/var/mizOS" ]; then
	echo "mizOS is already installed, skipping base system installation."
else
	printf "\n\n\nAre you installing SystemD mizOS onto an Asus laptop? (y/n)\n\n> "
	read ans

	if [ $ans == "y" ]; then
		echo "Installing Asus laptop utilities."
		sudo -S pacman -S asusctl supergfxctl
		echo "Enabling asusctl and supergfxctl."
		printf "\n\n\n Are you using the ISO image? (y/n)"
		read ans
		if [ $ans == "y" ]; then
			echo "After installation, run miz gfx setup."
		else
			sudo -S systemctl enable --now power-profiles-daemon.service
			sudo -S systemctl enable --now supergfxd
		fi
	fi

	if [ -d "$HOME/.config" ]; then
		echo ".config already exists."
	else
		mkdir $HOME/.config
	fi

	echo "Creating /var/mizOS"
	sudo mkdir /var/mizOS
	sudo chmod 777 /var/mizOS
	echo "Enabling fish."
	echo "fish" >> $HOME/.bashrc
fi



if [ -d "/var/mizOS/core" ]; then
	echo "core folder present."
else
	echo "Creating /var/mizOS/core"
	mkdir /var/mizOS/core
fi


if [ -d "/var/mizOS/config" ]; then
	echo "config folder present."
else
	echo "Creating /var/mizOS/config"
	mkdir /var/mizOS/config
fi


if [ -d "/var/mizOS/backup" ]; then
	echo "backup folder present."
else
	echo "Creating /var/mizOS/backup."
	mkdir /var/mizOS/backup
fi


if [ -d "/var/mizOS/wallpaper" ]; then
	echo "wallpaper folder present."
else
	echo "Creating /var/mizOS/wallpaper"
	mkdir /var/mizOS/wallpaper
fi


if [ -d "/var/mizOS/src" ]; then
	echo "src folder present."
else
	echo "creating /var/mizOS/src"
	mkdir /var/mizOS/src
fi


if [ -d "/var/mizOS/packages" ]; then
	echo "packages folder present."
else
	echo "Creating /var/mizOS/packages"
	mkdir /var/mizOS/packages
fi


if [ -d "/var/mizOS/work" ]; then
	echo "work folder present."
else
	echo "creating /var/mizOS/work"
	mkdir /var/mizOS/work
fi


if [ -d /var/mizOS/init ]; then
	echo "init folder present."
else
	echo "Detecting init system."
	mkdir /var/mizOS/init
	if test -f "/usr/bin/sv"; then
		echo "Runit detected"
		touch /var/mizOS/init/runit
	elif test -f "/usr/bin/systemctl"; then
		echo "SystemD detected"
		touch /var/mizOS/init/systemd
	elif test -f "/usr/bin/rc-service"; then
		echo "openRC detected"
		touch /var/mizOS/init/openrc
	fi
fi



echo "Replacing original neofetch file."
sudo -S rm /usr/bin/neofetch
sudo -S cp assets/details/neofetch /usr/bin


echo "Adding that amazing wallpaper to /var/mizOS/wallpaper."
cp assets/config/wallpaper.png /var/mizOS/wallpaper/


echo "Cleaning old backups, if any."
rm -rf /var/mizOS/backup/*

echo "Cleaning old config files, if any."
rm -rf /var/mizOS/config/*

echo "mizOS is about to install configuration files for i3-gaps, picom, and alacritty. If you already have configuration files for these programs, they will be backed up to /var/mizOS/backup."

if [ -d "$HOME/.config/i3" ]; then
	echo "Backing up current i3 configuration."
	mv $HOME/.config/i3 /var/mizOS/backup
fi


if [ -d "$HOME/.config/alacritty" ]; then
	echo "Backing current alacritty configuration."
	mv $HOME/.config/alacritty /var/mizOS/backup
fi


if [ -f "$HOME/.config/picom.conf" ]; then
	echo "Backing up current picom configuration."
	mv $HOME/.config/picom.conf /var/mizOS/backup
fi

if [ -f "$HOME/.config/fish/config.fish" ]; then
	echo "Backing up current fish configuration."
	mv $HOME/.config/fish/config.fish /var/mizOS/backup
fi

echo "Installing the i3 configuration file."
mkdir $HOME/.config/i3
cp assets/config/i3/config $HOME/.config/i3/
cp -r assets/config/i3 /var/mizOS/config


echo "Installing the Alacritty config file."
mkdir $HOME/.config/alacritty
mkdir /var/mizOS/config/alacritty
cp assets/config/alacritty.yml $HOME/.config/alacritty
cp assets/config/alacritty.yml /var/mizOS/config/alacritty

echo "Installing the fish configuration file."
cp assets/config/config.fish $HOME/.config/fish
cp assets/config/config.fish /var/mizOS/config

echo "Installing the Picom configuration file."
cp assets/config/picom.conf $HOME/.config
cp assets/config/picom.conf /var/mizOS/config


echo "Configuration files added."




echo "Installing the mizOS.lua backend."
if [ -f "/var/mizOS/core/mizOS.lua" ]; then
	rm /var/mizOS/core/mizOS.lua
fi
cp assets/os/mizOS.lua /var/mizOS/core

echo "Installing the miz frontend."
if [ -f "/usr/bin/miz" ]; then
	sudo rm /usr/bin/miz
fi
chmod +x assets/os/miz
sudo -S cp assets/os/miz /usr/bin


echo "Changing your os-release file."
sudo -S rm /etc/os-release
sudo -S cp assets/details/os-release /etc


echo "Changing your lsb-release file."
sudo -S rm /etc/lsb-release
sudo -S cp assets/details/lsb-release /etc


if [ -d "/var/mizOS/src/mizOS" ]; then
	echo "Cleaning source folder."
	rm -rf /var/mizOS/src/mizOS
fi


echo "My work here is done! You should probably reboot."
echo "  "
echo "If you are currently using i3-gaps, reload with MOD+shift+c to see theming changes."
echo " "
echo "! WARNING ! PLEASE REFRAIN FROM USING sudo pacman -Syu to update, instead, PLEASE use miz update"
